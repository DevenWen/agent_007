# Agent å¹³å°é€»è¾‘å®¡è®¡æŠ¥å‘Š

## 1. Scenario Extraction

| # | Scenario | Entities Involved | Key Actions |
|---|----------|-------------------|-------------|
| 1 | ç”¨æˆ·åˆ›å»ºå¹¶æäº¤ Ticket | User, Ticket, Agent | create(), start() |
| 2 | ä¸»å¾ªç¯æ´¾å‘ Ticket ç»™ Agent | MainLoop, Ticket, Agent, Session | dispatch(), createSession() |
| 3 | Agent æ‰§è¡Œä»»åŠ¡å¹¶æ›´æ–°æ­¥éª¤ | Agent, Session, Ticket, Tool | execute(), addStep(), addMessage() |
| 4 | Agent è¯·æ±‚äººå·¥ä»‹å…¥ | Agent, Session, Ticket | suspend(), waitForInput() |
| 5 | ç”¨æˆ·å®Œæˆäººå·¥ä»‹å…¥ | User, Session, Ticket | submitInput(), resume() |
| 6 | Ticket é‡ç½®ä¸ºå¾…å¤„ç† | Ticket, Session | reset(), createNewSession() |
| 7 | ä»»åŠ¡å®Œæˆ/å¤±è´¥ | Agent, Session, Ticket | complete(), fail() |

> **Total scenarios identified**: 7

---

## 2. Sequence Diagrams

### Scenario 1: ç”¨æˆ·åˆ›å»ºå¹¶æäº¤ Ticket

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant API as API Server
    participant T as Ticket
    participant A as Agent

    U->>API: POST /tickets {agent_id, params, context}
    API->>T: create(agent_id, params, context)
    T->>T: setStatus("pending")
    T-->>API: ticketCreated(id)
    API-->>U: 201 Created {ticket_id}
```

**Observations**:
- âœ… æµç¨‹æ¸…æ™°ï¼ŒTicket åˆ›å»ºåè¿›å…¥ pending çŠ¶æ€ç­‰å¾…ä¸»å¾ªç¯æ´¾å‘
- âš ï¸ ç¼ºå¤±ï¼šåˆ›å»ºæ—¶æ˜¯å¦éªŒè¯ agent_id å­˜åœ¨ï¼Ÿ

---

### Scenario 2: ä¸»å¾ªç¯æ´¾å‘ Ticket ç»™ Agent

```mermaid
sequenceDiagram
    autonumber
    participant ML as MainLoop
    participant T as Ticket
    participant A as Agent
    participant S as Session

    loop æ¯ 1-3 ç§’
        ML->>T: findPendingTickets()
        T-->>ML: [ticket1, ticket2, ...]
    end
    ML->>T: getAgent(ticket.agent_id)
    T-->>ML: agent
    ML->>S: create(ticket_id)
    S->>S: setStatus("active")
    ML->>T: setStatus("running")
    ML->>A: execute(session, ticket)
```

**Observations**:
- âœ… è½®è¯¢æœºåˆ¶ç¬¦åˆè®¾è®¡å†³ç­– (1-3 ç§’é—´éš”)
- âš ï¸ ç¼ºå¤±ï¼šå¦‚æœ Agent æ­£åœ¨æ‰§è¡Œå¦ä¸€ä¸ªä»»åŠ¡æ€ä¹ˆåŠï¼Ÿæ˜¯å¦æ”¯æŒå¹¶å‘ï¼Ÿ
- âš ï¸ ç¼ºå¤±ï¼šMainLoop æ˜¯å¦éœ€è¦ä½œä¸ºé¢†åŸŸæ¦‚å¿µï¼Ÿç›®å‰æœªåœ¨ W1 ä¸­å®šä¹‰

---

### Scenario 3: Agent æ‰§è¡Œä»»åŠ¡å¹¶æ›´æ–°æ­¥éª¤

```mermaid
sequenceDiagram
    autonumber
    participant A as Agent
    participant S as Session
    participant LLM as Claude API
    participant Tool as Tool
    participant T as Ticket

    A->>A: getPrompt()
    A->>S: getContext()
    A->>S: getMessages()
    A->>LLM: chat(prompt, context, messages)
    LLM-->>A: response (text or tool_call)
    
    alt Tool Call
        A->>Tool: execute(params)
        Tool-->>A: result
        A->>S: addMessage(role="tool", content=result)
    else Text Response
        A->>S: addMessage(role="assistant", content=text)
    end
    
    A->>T: addStep(title, status="completed", result)
    A->>S: updateContext(newState)
```

**Observations**:
- âœ… æ ¸å¿ƒæ‰§è¡Œæµç¨‹å®Œæ•´
- âš ï¸ ç¼ºå¤±ï¼šStep ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿæ˜¯å…ˆåˆ›å»º (pending) å†æ›´æ–° (completed)ï¼Œè¿˜æ˜¯å®Œæˆåç›´æ¥æ·»åŠ ï¼Ÿ
- âš ï¸ ç¼ºå¤±ï¼šTool.execute() å¤±è´¥å¦‚ä½•å¤„ç†ï¼Ÿ
- âš ï¸ ç¼ºå¤±ï¼šSession.context å’Œ Ticket.context åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚ä½•åè°ƒï¼Ÿ

---

### Scenario 4: Agent è¯·æ±‚äººå·¥ä»‹å…¥

```mermaid
sequenceDiagram
    autonumber
    participant A as Agent
    participant S as Session
    participant T as Ticket
    participant LLM as Claude API

    A->>LLM: chat(...)
    LLM-->>A: response (éœ€è¦äººå·¥è¾“å…¥)
    A->>S: addMessage(role="assistant", content="è¯·æä¾›...")
    A->>S: suspend()
    S->>S: setStatus("suspended")
    A->>T: suspend()
    T->>T: setStatus("suspended")
    Note over T,S: ç­‰å¾…ç”¨æˆ·è¾“å…¥
```

**Observations**:
- âœ… Ticket å’Œ Session çŠ¶æ€åŒæ­¥æŒ‚èµ·
- âš ï¸ ç¼ºå¤±ï¼šAgent å¦‚ä½•åˆ¤æ–­"éœ€è¦äººå·¥è¾“å…¥"ï¼Ÿæ˜¯ LLM è¿”å›ç‰¹å®šæ ¼å¼ï¼Œè¿˜æ˜¯ Agent è‡ªè¡Œåˆ†æï¼Ÿ
- âš ï¸ ç¼ºå¤±ï¼šæŒ‚èµ·æ—¶éœ€è¦å­˜å‚¨"ç­‰å¾…ä»€ä¹ˆè¾“å…¥"çš„æç¤ºä¿¡æ¯ï¼Œå½“å‰ Message èƒ½å¦æ»¡è¶³ï¼Ÿ

---

### Scenario 5: ç”¨æˆ·å®Œæˆäººå·¥ä»‹å…¥

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant API as API Server
    participant S as Session
    participant T as Ticket
    participant ML as MainLoop

    U->>API: POST /sessions/{id}/messages {content}
    API->>S: addMessage(role="user", content)
    API->>S: resume()
    S->>S: setStatus("active")
    API->>T: setStatus("pending")
    Note over T: é‡æ–°è¿›å…¥å¾…æ´¾å‘çŠ¶æ€
    API-->>U: 200 OK
    
    ML->>T: findPendingTickets()
    Note over ML: ä¸»å¾ªç¯é‡æ–°æ´¾å‘
```

**Observations**:
- âš ï¸ é‡è¦é—®é¢˜ï¼šç”¨æˆ·å›å¤å Ticket å˜ä¸º pendingï¼Œä½† Session å·²ç»å­˜åœ¨ã€‚ä¸»å¾ªç¯æ˜¯å¦ä¼šåˆ›å»ºæ–° Sessionï¼Ÿ
- âš ï¸ è¿™é‡Œä¸ W1 çš„è®¾è®¡å†³ç­–å†²çªï¼š"ä¸€ä¸ª Ticket åœ¨è¿è¡Œä¸­å¯¹åº”ä¸€ä¸ª Sessionï¼Œä½†å‡å¦‚ Ticket è¢«å‰ç½®ä¸ºå¾…å¤„ç†ï¼Œåˆ™éœ€è¦é‡æ–°åˆ›å»º session å®ä¾‹"
- ğŸ”´ **å…³é”®ç¼ºå£**ï¼šæŒ‚èµ·æ¢å¤ vs é‡ç½®ä¸ºå¾…å¤„ç†ï¼Œæ˜¯ä¸¤ç§ä¸åŒçš„åœºæ™¯ï¼Œéœ€è¦åŒºåˆ†ï¼

---

### Scenario 6: Ticket é‡ç½®ä¸ºå¾…å¤„ç†ï¼ˆåˆ›å»ºæ–° Sessionï¼‰

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant API as API Server
    participant T as Ticket
    participant S1 as Old Session
    participant S2 as New Session

    U->>API: POST /tickets/{id}/reset
    API->>T: reset()
    T->>T: setStatus("pending")
    T->>T: clearSteps()
    API->>S1: complete()
    S1->>S1: setStatus("completed")
    Note over S1: æ—§ Session å½’æ¡£
    API-->>U: 200 OK
    
    Note over T: ä¸»å¾ªç¯æ´¾å‘æ—¶åˆ›å»ºæ–° Session
```

**Observations**:
- âœ… ç¬¦åˆ"ä¸€ä¸ª Ticket å¯ä»¥æœ‰å¤šä¸ª Session å†å²"çš„è®¾è®¡
- âš ï¸ ç¼ºå¤±ï¼šreset() æ˜¯å¦åº”è¯¥æ¸…ç©º stepsï¼Ÿè¿˜æ˜¯ä¿ç•™å†å²ï¼Ÿ
- âš ï¸ ç¼ºå¤±ï¼šTicket.contextï¼ˆé™æ€ï¼‰æ˜¯å¦é‡ç½®ï¼ŸæŒ‰å®šä¹‰åº”è¯¥ä¸å¯å˜

---

### Scenario 7: ä»»åŠ¡å®Œæˆ/å¤±è´¥

```mermaid
sequenceDiagram
    autonumber
    participant A as Agent
    participant S as Session
    participant T as Ticket
    participant LLM as Claude API

    A->>LLM: chat(...)
    LLM-->>A: response (ä»»åŠ¡å®Œæˆ)
    
    alt æˆåŠŸ
        A->>S: complete()
        S->>S: setStatus("completed")
        A->>T: complete()
        T->>T: setStatus("completed")
    else å¤±è´¥
        A->>S: fail()
        S->>S: setStatus("failed")
        A->>T: fail()
        T->>T: setStatus("failed")
    end
```

**Observations**:
- âš ï¸ ç¼ºå¤±ï¼šSession æ²¡æœ‰ failed çŠ¶æ€ï¼ˆW1 åªå®šä¹‰äº† active | suspended | completedï¼‰
- âš ï¸ ç¼ºå¤±ï¼šå¤±è´¥åŸå› å­˜å‚¨åœ¨å“ªé‡Œï¼ŸTicket è¿˜æ˜¯ Sessionï¼Ÿ
- âš ï¸ ç¼ºå¤±ï¼šAgent å¦‚ä½•åˆ¤æ–­"ä»»åŠ¡å®Œæˆ"ï¼ŸLLM è¿”å›ç‰¹å®šæ ‡è®°ï¼Ÿ

---

## 3. Gap Analysis Report

### Summary

| Severity | Count | Description |
|----------|-------|-------------|
| ğŸ”´ Critical | 2 | é˜»å¡æ ¸å¿ƒæµç¨‹çš„è®¾è®¡ç¼ºé™· |
| ğŸŸ  Major | 4 | èŒè´£ä¸æ¸…æˆ–è°ƒç”¨é“¾æ–­è£‚ |
| ğŸŸ¡ Minor | 3 | ä¼˜åŒ–å»ºè®® |
| ğŸ”µ Info | 2 | éœ€è¦æ¾„æ¸…çš„é—®é¢˜ |

---

### ğŸ”´ Critical Issues

#### GAP-001: æŒ‚èµ·æ¢å¤ vs é‡ç½®ä¸ºå¾…å¤„ç† åœºæ™¯æ··æ·†

- **Scenario**: Scenario 5 & 6
- **Problem**: W1 è®¾è®¡å†³ç­–è¯´"Ticket è¢«å‰ç½®ä¸ºå¾…å¤„ç†åˆ™éœ€è¦é‡æ–°åˆ›å»º session"ï¼Œä½†æŒ‚èµ·åæ¢å¤ä¸åº”è¯¥åˆ›å»ºæ–° Sessionï¼Œåº”è¯¥ç»§ç»­ä½¿ç”¨å½“å‰ Sessionã€‚
- **Impact**: å¦‚æœæŒ‚èµ·æ¢å¤ä¹Ÿåˆ›å»ºæ–° Sessionï¼Œå¯¹è¯å†å²ä¼šä¸¢å¤±ã€‚
- **Suggested Fix**: 
  - åŒºåˆ†ä¸¤ç§æ“ä½œï¼š`resume()` æ¢å¤æŒ‚èµ·ï¼ˆä¸åˆ›å»ºæ–° Sessionï¼‰ï¼Œ`reset()` é‡ç½®ï¼ˆåˆ›å»ºæ–° Sessionï¼‰
  - Ticket çŠ¶æ€å¢åŠ  `suspended` çŠ¶æ€ï¼Œä¸ `pending` åŒºåˆ†

#### GAP-002: Session ç¼ºå°‘ failed çŠ¶æ€

- **Scenario**: Scenario 7
- **Problem**: Session.status åªæœ‰ `active | suspended | completed`ï¼Œæ²¡æœ‰ `failed`
- **Impact**: æ— æ³•åŒºåˆ† Session æ˜¯æ­£å¸¸å®Œæˆè¿˜æ˜¯å¤±è´¥ç»ˆæ­¢
- **Suggested Fix**: æ·»åŠ  `failed` çŠ¶æ€åˆ° Session.status enum

---

### ğŸŸ  Major Issues

#### GAP-003: MainLoop æœªä½œä¸ºé¢†åŸŸæ¦‚å¿µå®šä¹‰

- **Scenario**: Scenario 2
- **Problem**: ä¸»å¾ªç¯æ˜¯æ ¸å¿ƒè°ƒåº¦ç»„ä»¶ï¼Œä½†æœªåœ¨ W1 ä¸­å®šä¹‰
- **Impact**: èŒè´£è¾¹ç•Œä¸æ¸…ï¼Œå®ç°æ—¶å®¹æ˜“äº§ç”Ÿæ··ä¹±
- **Suggested Fix**: æ·»åŠ  `Scheduler` æˆ– `Dispatcher` ä½œä¸ºåº”ç”¨æœåŠ¡ï¼ˆéé¢†åŸŸå®ä½“ï¼‰ï¼Œæ˜ç¡®å…¶èŒè´£

#### GAP-004: Agent å¹¶å‘æ‰§è¡Œç­–ç•¥æœªå®šä¹‰

- **Scenario**: Scenario 2
- **Problem**: å¦‚æœä¸€ä¸ª Agent è¢«åˆ†é…ç»™å¤šä¸ª Ticketï¼Œæ˜¯å¹¶å‘æ‰§è¡Œè¿˜æ˜¯æ’é˜Ÿï¼Ÿ
- **Impact**: å½±å“ç³»ç»Ÿååé‡è®¾è®¡
- **Suggested Fix**: æ˜ç¡®ç­–ç•¥ï¼š1) ä¸€ä¸ª Agent å¯åŒæ—¶å¤„ç†å¤šä¸ª Ticketï¼ˆå¹¶å‘ï¼‰ï¼Œæˆ– 2) ä¸€ä¸ª Agent åŒæ—¶åªå¤„ç†ä¸€ä¸ª

#### GAP-005: Tool æ‰§è¡Œå¤±è´¥å¤„ç†æœªå®šä¹‰

- **Scenario**: Scenario 3
- **Problem**: Tool.execute() å¤±è´¥åå¦‚ä½•å¤„ç†ï¼Ÿæ˜¯é‡è¯•ã€è·³è¿‡è¿˜æ˜¯ç»ˆæ­¢ä»»åŠ¡ï¼Ÿ
- **Impact**: å½±å“ç³»ç»Ÿå¥å£®æ€§
- **Suggested Fix**: 
  - Tool è¿”å›ç»“æ„åŒ–ç»“æœ `{success: boolean, result?: any, error?: string}`
  - Agent æ ¹æ® LLM åˆ¤æ–­å†³å®šåç»­åŠ¨ä½œ

#### GAP-006: ä»»åŠ¡å®Œæˆ/äººå·¥ä»‹å…¥çš„åˆ¤æ–­æœºåˆ¶ä¸æ˜ç¡®

- **Scenario**: Scenario 4 & 7
- **Problem**: Agent å¦‚ä½•åˆ¤æ–­ LLM è¿”å›éœ€è¦"äººå·¥ä»‹å…¥"æˆ–"ä»»åŠ¡å®Œæˆ"ï¼Ÿ
- **Impact**: å½±å“ Agent çš„æ§åˆ¶æµå®ç°
- **Suggested Fix**: 
  - ä½¿ç”¨ `claude_agent_sdk` çš„ tool æœºåˆ¶ï¼Œå®šä¹‰ `request_human_input` å’Œ `complete_task` ä½œä¸º Agent å¯è°ƒç”¨çš„"ç³»ç»Ÿå·¥å…·"

---

### ğŸŸ¡ Minor Issues

#### GAP-007: Step åˆ›å»ºæ—¶æœºä¸æ˜ç¡®

- **Scenario**: Scenario 3
- **Problem**: Step æ˜¯å…ˆåˆ›å»º (pending) å†æ›´æ–° (running â†’ completed)ï¼Œè¿˜æ˜¯å®Œæˆåä¸€æ¬¡æ€§æ·»åŠ ï¼Ÿ
- **Impact**: å½±å“å‰ç«¯è¿›åº¦å±•ç¤º
- **Suggested Fix**: å»ºè®®å…ˆåˆ›å»º (pending)ï¼Œæ‰§è¡Œä¸­æ›´æ–°ä¸º (running)ï¼Œä¾¿äºå®æ—¶å±•ç¤ºè¿›åº¦

#### GAP-008: å¤±è´¥åŸå› å­˜å‚¨ä½ç½®ä¸æ˜ç¡®

- **Scenario**: Scenario 7
- **Problem**: ä»»åŠ¡å¤±è´¥æ—¶ï¼Œå¤±è´¥åŸå› å­˜å‚¨åœ¨ Ticket è¿˜æ˜¯ Sessionï¼Ÿ
- **Impact**: å½±å“é”™è¯¯è¿½è¸ª
- **Suggested Fix**: 
  - Ticket æ·»åŠ  `error_message: string` å±æ€§
  - æˆ–è€…æœ€åä¸€æ¡ Session.messages è®°å½•é”™è¯¯è¯¦æƒ…

#### GAP-009: Ticket.steps åœ¨ reset æ—¶æ˜¯å¦æ¸…ç©º

- **Scenario**: Scenario 6
- **Problem**: reset() æ—¶æ˜¯æ¸…ç©º steps è¿˜æ˜¯ä¿ç•™å†å²ï¼Ÿ
- **Impact**: å½±å“ä»»åŠ¡è¿½æº¯
- **Suggested Fix**: ä¿ç•™ steps ä½œä¸ºå†å²è®°å½•ï¼Œæ–° Session çš„ steps è¿½åŠ åˆ°åé¢

---

### ğŸ”µ Info / Questions

- **Q1**: æŠ€æœ¯é€‰å‹ä¸­ä½¿ç”¨ `claude_agent_sdk`ï¼Œæ˜¯å¦éœ€è¦åœ¨é¢†åŸŸæ¨¡å‹ä¸­æ˜¾å¼ä½“ç° LLM è°ƒç”¨ï¼Ÿ
- **Q2**: Agent çš„ `prompt` æ˜¯çº¯æ–‡æœ¬è¿˜æ˜¯æ”¯æŒæ¨¡æ¿å˜é‡ï¼ˆå¦‚ `{{ticket.params}}`ï¼‰ï¼Ÿ

---

## 4. Refinement Suggestions

> ä»¥ä¸‹å»ºè®®åº”æ›´æ–°åˆ° W1 é¢†åŸŸæ¨¡å‹ä¸­ã€‚

### For Ticket (å·¥å•)

| Change | Type | Rationale |
|--------|------|-----------|
| çŠ¶æ€å¢åŠ  `suspended` | Modify Property | GAP-001: åŒºåˆ†æŒ‚èµ·å’Œå¾…å¤„ç† |
| æ·»åŠ  `error_message: string` | New Property | GAP-008: å­˜å‚¨å¤±è´¥åŸå›  |
| æ·»åŠ  `resume()` è¡Œä¸º | New Behavior | GAP-001: æŒ‚èµ·æ¢å¤æ“ä½œ |
| æ·»åŠ  `reset()` è¡Œä¸º | New Behavior | GAP-001: é‡ç½®æ“ä½œï¼ˆåˆ›å»ºæ–° Sessionï¼‰ |

**æ›´æ–°åçš„çŠ¶æ€å›¾**:
```
pending â†’ running â†’ suspended â†’ running (æ¢å¤)
                  â†˜ completed
                  â†˜ failed
       â† reset() â†
```

### For Session (ä¼šè¯)

| Change | Type | Rationale |
|--------|------|-----------|
| çŠ¶æ€å¢åŠ  `failed` | Modify Property | GAP-002: åŒºåˆ†æ­£å¸¸å®Œæˆå’Œå¤±è´¥ |

### For Tool (å·¥å…·)

| Change | Type | Rationale |
|--------|------|-----------|
| è¿”å›å€¼ç»“æ„åŒ– `{success, result, error}` | Modify Behavior | GAP-005: æ”¯æŒå¤±è´¥å¤„ç† |

### New Concepts to Consider

| Concept | Type | Rationale |
|---------|------|-----------|
| Scheduler | Application Service | GAP-003: ä¸»å¾ªç¯è°ƒåº¦å™¨ï¼Œéé¢†åŸŸå®ä½“ |
| SystemTool (request_human_input, complete_task) | Special Tool Type | GAP-006: Agent æ§åˆ¶æµå·¥å…· |

---

## 5. Verification Checklist

| # | Scenario | Test Case | Expected Outcome |
|---|----------|-----------|------------------|
| 1 | åˆ›å»º Ticket | åˆ›å»º Ticket æŒ‡å®šæœ‰æ•ˆ agent_id | Ticket åˆ›å»ºæˆåŠŸï¼Œstatus = "pending" |
| 2 | åˆ›å»º Ticket | åˆ›å»º Ticket æŒ‡å®šæ— æ•ˆ agent_id | è¿”å› 404 é”™è¯¯ |
| 3 | æ´¾å‘ Ticket | ä¸»å¾ªç¯æ‰«æåˆ° pending Ticket | åˆ›å»º Sessionï¼ŒTicket status â†’ "running" |
| 4 | æ‰§è¡Œä»»åŠ¡ | Agent è°ƒç”¨ Tool æˆåŠŸ | Session æ·»åŠ  tool messageï¼ŒTicket æ·»åŠ  step |
| 5 | æ‰§è¡Œä»»åŠ¡ | Agent è°ƒç”¨ Tool å¤±è´¥ | Tool è¿”å› errorï¼ŒAgent ç»§ç»­æˆ–ç»ˆæ­¢ä»»åŠ¡ |
| 6 | äººå·¥ä»‹å…¥ | Agent åˆ¤æ–­éœ€è¦äººå·¥è¾“å…¥ | Session/Ticket status â†’ "suspended" |
| 7 | æ¢å¤æ‰§è¡Œ | ç”¨æˆ·æäº¤è¾“å…¥ï¼Œè°ƒç”¨ resume | Session status â†’ "active"ï¼ŒTicket â†’ "running"ï¼Œç»§ç»­åŸ Session |
| 8 | é‡ç½® Ticket | ç”¨æˆ·è°ƒç”¨ reset | Ticket status â†’ "pending"ï¼Œæ—§ Session å®Œæˆï¼Œä¸»å¾ªç¯åˆ›å»ºæ–° Session |
| 9 | ä»»åŠ¡å®Œæˆ | Agent åˆ¤æ–­ä»»åŠ¡å®Œæˆ | Session/Ticket status â†’ "completed" |
| 10 | ä»»åŠ¡å¤±è´¥ | Agent é‡åˆ°ä¸å¯æ¢å¤é”™è¯¯ | Session/Ticket status â†’ "failed"ï¼Œè®°å½• error_message |
