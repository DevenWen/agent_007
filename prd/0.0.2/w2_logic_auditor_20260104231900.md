# Agent å¹³å°é€»è¾‘å®¡è®¡æŠ¥å‘Š (v0.0.2 å¢é‡)

> æœ¬æ–‡æ¡£æ˜¯å¯¹ `prd/0.0.1/w2_logic_auditor_20260104142548.md` çš„å¢é‡æ›´æ–°ï¼Œä»…å®¡è®¡ 0.0.2 ç‰ˆæœ¬æ–°å¢çš„åœºæ™¯å’ŒåŠŸèƒ½ã€‚

---

## 1. Scenario Extraction

| # | Scenario | Entities Involved | Key Actions | ç±»å‹ |
|---|----------|-------------------|-------------|------|
| 8 | ç”¨æˆ·åˆ›å»º Ticketï¼ˆå¸¦åŠ¨æ€è¡¨å•ï¼‰ | User, Agent, Ticket | getParamsSchema(), validateParams(), create() | **æ–°å¢** |
| 9 | Executor ä½¿ç”¨ claude_agent_sdk æ‰§è¡Œä»»åŠ¡ | Executor, Agent, Session, Tool | query(), handleToolCall() | **æ–°å¢** |
| 10 | å‰ç«¯ Ticket åˆ—è¡¨è‡ªåŠ¨åˆ·æ–° | Frontend, API | fetchTickets() (interval) | **æ–°å¢** |
| 11 | å‰ç«¯è·³è½¬åˆ°å½“å‰ Session | Frontend, Ticket, Session | getLatestSession(), navigate() | **æ–°å¢** |

> **æ–°å¢åœºæ™¯æ•°é‡**: 4

---

## 2. Sequence Diagrams

### Scenario 8: ç”¨æˆ·åˆ›å»º Ticketï¼ˆå¸¦åŠ¨æ€è¡¨å•ï¼‰

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Server
    participant A as Agent
    participant T as Ticket

    U->>FE: é€‰æ‹© Agent
    FE->>API: GET /agents/{id}
    API->>A: getParamsSchema()
    A-->>API: params_schema (JSON Schema)
    API-->>FE: {agent_id, name, params_schema}
    FE->>FE: åŠ¨æ€æ¸²æŸ“è¡¨å•
    U->>FE: å¡«å†™è¡¨å•å¹¶æäº¤
    FE->>FE: å®¢æˆ·ç«¯æ ¡éªŒ (JSON Schema)
    FE->>API: POST /tickets {agent_id, params}
    API->>A: validateParams(params)
    A-->>API: {valid: true/false, errors?: []}
    alt æ ¡éªŒå¤±è´¥
        API-->>FE: 400 Bad Request {errors}
        FE->>U: æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    else æ ¡éªŒæˆåŠŸ
        API->>T: create(agent_id, params)
        T-->>API: ticketCreated(id)
        API-->>FE: 201 Created {ticket_id}
        FE->>U: è·³è½¬åˆ° Ticket è¯¦æƒ…
    end
```

**Observations**:
- âœ… åŒé‡æ ¡éªŒï¼ˆå‰ç«¯ + åç«¯ï¼‰ç¡®ä¿æ•°æ®æœ‰æ•ˆæ€§
- âš ï¸ ç¼ºå¤±ï¼šAgent çš„ `params_schema` ä½•æ—¶åˆ›å»º/æ›´æ–°ï¼Ÿéœ€è¦ CRUD API æ”¯æŒ
- âš ï¸ ç¼ºå¤±ï¼šå¦‚æœ `params_schema` ä¸ºç©º/nullï¼Œè¡¨å•å¦‚ä½•å¤„ç†ï¼Ÿ

---

### Scenario 9: Executor ä½¿ç”¨ claude_agent_sdk æ‰§è¡Œä»»åŠ¡

```mermaid
sequenceDiagram
    autonumber
    participant D as Dispatcher
    participant E as Executor
    participant SDK as claude_agent_sdk
    participant Tool as Tool
    participant S as Session
    participant T as Ticket

    D->>E: execute(ticket_id, session_id)
    E->>E: loadTicket(), loadSession(), loadAgent()
    E->>SDK: ClaudeSDKClient(options)
    E->>SDK: set system prompt
    E->>SDK: register custom tools
    
    loop Agentic Loop
        E->>SDK: send(messages)
        SDK-->>E: response (text or tool_use)
        
        alt Tool Call
            E->>Tool: execute(tool_name, params)
            Tool-->>E: result
            E->>S: addMessage(role="tool", content=result)
        else System Tool (request_human_input)
            E->>S: suspend()
            E->>T: suspend()
            Note over E: é€€å‡ºå¾ªç¯
        else System Tool (complete_task)
            E->>S: complete()
            E->>T: complete()
            Note over E: é€€å‡ºå¾ªç¯
        else Text Response
            E->>S: addMessage(role="assistant", content=text)
        end
    end
```

**Observations**:
- âœ… ä½¿ç”¨ `ClaudeSDKClient` æœ‰çŠ¶æ€å®¢æˆ·ç«¯ï¼Œç¬¦åˆå¤šè½®å¯¹è¯éœ€æ±‚
- âš ï¸ è®¾è®¡å†³ç­–ï¼šexecutor.py å’Œ executor2.py å¹¶å­˜ï¼Œéœ€è¦æŠ½è±¡å…¬å…±é€»è¾‘
- âš ï¸ ç¼ºå¤±ï¼šä¸¤ä¸ª Executor å¦‚ä½•é€‰æ‹©ï¼Ÿé…ç½®åˆ‡æ¢ï¼Ÿè¿˜æ˜¯æ ¹æ® Agent å±æ€§å†³å®šï¼Ÿ

---

### Scenario 10: å‰ç«¯ Ticket åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Server

    U->>FE: è¿›å…¥ Ticket åˆ—è¡¨é¡µé¢
    FE->>API: GET /tickets
    API-->>FE: [ticket1, ticket2, ...]
    FE->>FE: æ¸²æŸ“åˆ—è¡¨
    
    loop æ¯ 5 ç§’
        FE->>API: GET /tickets
        API-->>FE: [ticket1, ticket2, ...]
        FE->>FE: æ›´æ–°åˆ—è¡¨ (ä¿æŒæ»šåŠ¨ä½ç½®)
    end
    
    U->>FE: ç¦»å¼€é¡µé¢
    FE->>FE: æ¸…é™¤ interval
```

**Observations**:
- âœ… çº¯å‰ç«¯å®ç°ï¼Œæ— åç«¯å˜æ›´
- âš ï¸ UX ä¼˜åŒ–ï¼šåˆ·æ–°æ—¶åº”ä¿æŒæ»šåŠ¨ä½ç½®å’Œé€‰ä¸­çŠ¶æ€
- âš ï¸ æ€§èƒ½ä¼˜åŒ–ï¼šè€ƒè™‘ä½¿ç”¨ Last-Modified / ETag å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“

---

### Scenario 11: å‰ç«¯è·³è½¬åˆ°å½“å‰ Session

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Server

    U->>FE: æ‰“å¼€ Ticket è¯¦æƒ…
    FE->>API: GET /tickets/{id}
    API-->>FE: {ticket, sessions: [{id, status, created_at}, ...]}
    FE->>FE: æ¸²æŸ“ Ticket è¯¦æƒ…
    FE->>FE: æ˜¾ç¤º "Session" æŒ‰é’® (å¦‚æœæœ‰ sessions)
    
    U->>FE: ç‚¹å‡» "Session" æŒ‰é’®
    FE->>FE: è·å–æœ€æ–° Session (æŒ‰ created_at æ’åº)
    FE->>FE: navigate(/sessions/{latestSessionId})
```

**Observations**:
- âœ… ç®€æ´çš„å¯¼èˆªé€»è¾‘
- âš ï¸ ç¼ºå¤±ï¼šå¦‚æœ Ticket æ²¡æœ‰ä»»ä½• Sessionï¼ˆä»æœªè¢«æ‰§è¡Œï¼‰ï¼ŒæŒ‰é’®å¦‚ä½•å¤„ç†ï¼Ÿ
- âš ï¸ ç¼ºå¤±ï¼šAPI æ˜¯å¦è¿”å›å…³è”çš„ sessions åˆ—è¡¨ï¼Ÿè¿˜æ˜¯éœ€è¦é¢å¤–æŸ¥è¯¢ï¼Ÿ

---

## 3. Gap Analysis Report

### Summary

| Severity | Count | Description |
|----------|-------|-------------|
| ğŸŸ  Major | 2 | å…³é”®æµç¨‹ä¸­çš„èŒè´£ä¸æ¸… |
| ğŸŸ¡ Minor | 4 | è¾¹ç•Œæƒ…å†µå¤„ç†æˆ–ä¼˜åŒ–å»ºè®® |
| ğŸ”µ Info | 1 | éœ€è¦æ¾„æ¸…çš„é—®é¢˜ |

---

### ğŸŸ  Major Issues

#### GAP-010: Executor é€‰æ‹©ç­–ç•¥æœªå®šä¹‰

- **Scenario**: Scenario 9
- **Problem**: è®¾è®¡å†³ç­–ç¡®è®¤ `executor.py` å’Œ `executor2.py` ä¸¤è€…å¹¶å­˜ï¼Œä½†æœªå®šä¹‰é€‰æ‹©ç­–ç•¥
- **Impact**: è°ƒåº¦å™¨ä¸çŸ¥é“è¯¥ä½¿ç”¨å“ªä¸ª Executor
- **Suggested Fix**: 
  - æ–¹æ¡ˆ A: å…¨å±€é…ç½®åˆ‡æ¢ï¼ˆç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ï¼‰
  - æ–¹æ¡ˆ B: Agent å±æ€§æŒ‡å®šï¼ˆå¦‚ `agent.executor_type = "sdk" | "anthropic"`ï¼‰
  - æ–¹æ¡ˆ C: ç»Ÿä¸€æ¥å£ï¼Œè¿è¡Œæ—¶æ³¨å…¥ï¼ˆæ¨èï¼Œç¬¦åˆæŠ½è±¡ç­–ç•¥ï¼‰

#### GAP-011: params_schema ç®¡ç† API ç¼ºå¤±

- **Scenario**: Scenario 8
- **Problem**: Agent çš„ `params_schema` éœ€è¦ CRUD æ”¯æŒï¼Œä½† W1 åªå®šä¹‰äº†å­˜å‚¨ä½ç½®
- **Impact**: æ— æ³•åˆ›å»ºæˆ–æ›´æ–° Agent çš„å‚æ•°æ¨¡å¼
- **Suggested Fix**: 
  - Agent API æ‰©å±•ï¼šPUT /agents/{id} æ”¯æŒæ›´æ–° params_schema
  - ç®¡ç†ç•Œé¢ï¼šAgent è¯¦æƒ…é¡µæ·»åŠ  schema ç¼–è¾‘å™¨

---

### ğŸŸ¡ Minor Issues

#### GAP-012: params_schema ä¸ºç©ºæ—¶çš„è¡¨å•å¤„ç†

- **Scenario**: Scenario 8
- **Problem**: å¦‚æœ Agent æœªå®šä¹‰ params_schemaï¼Œå‰ç«¯å¦‚ä½•æ¸²æŸ“è¡¨å•ï¼Ÿ
- **Suggested Fix**: 
  - æ˜¾ç¤ºé€šç”¨ JSON è¾“å…¥æ¡†ï¼ˆè‡ªç”±æ ¼å¼ï¼‰
  - æˆ–è€…ç¦æ­¢åˆ›å»º Ticketï¼Œæç¤ºç®¡ç†å‘˜å…ˆé…ç½® schema

#### GAP-013: Ticket æ—  Session æ—¶çš„æŒ‰é’®çŠ¶æ€

- **Scenario**: Scenario 11
- **Problem**: ä»æœªæ‰§è¡Œçš„ Ticket æ²¡æœ‰ Sessionï¼Œæ­¤æ—¶ Session æŒ‰é’®åº”è¯¥å¦‚ä½•æ˜¾ç¤ºï¼Ÿ
- **Suggested Fix**: 
  - ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤º tooltip "å°šæ— æ‰§è¡Œè®°å½•"
  - æˆ–è€…éšè—æŒ‰é’®

#### GAP-014: è‡ªåŠ¨åˆ·æ–°çš„ UX ä¼˜åŒ–

- **Scenario**: Scenario 10
- **Problem**: åˆ·æ–°æ—¶å¯èƒ½æ‰“æ–­ç”¨æˆ·æ“ä½œï¼ˆå¦‚æ»šåŠ¨ã€é€‰ä¸­ï¼‰
- **Suggested Fix**: 
  - ä¿æŒæ»šåŠ¨ä½ç½®
  - ä¿æŒè¡Œé€‰ä¸­çŠ¶æ€
  - æ˜¾ç¤º "ä¸Šæ¬¡æ›´æ–°æ—¶é—´"

#### GAP-015: Ticket API æ˜¯å¦è¿”å› sessions åˆ—è¡¨

- **Scenario**: Scenario 11
- **Problem**: å½“å‰ API è®¾è®¡æœªæ˜ç¡®æ˜¯å¦åœ¨ GET /tickets/{id} ä¸­ embed sessions
- **Suggested Fix**: 
  - æ–¹æ¡ˆ A: embed sessionsï¼ˆç®€åŒ–å‰ç«¯è¯·æ±‚ï¼‰
  - æ–¹æ¡ˆ B: å•ç‹¬æ¥å£ GET /tickets/{id}/sessionsï¼ˆæŒ‰éœ€åŠ è½½ï¼‰

---

### ğŸ”µ Info / Questions

- **Q3**: Executor æŠ½è±¡ç­–ç•¥ç¡®è®¤ - æ˜¯ä½¿ç”¨æ¥å£/åŸºç±»ç»§æ‰¿ï¼Œè¿˜æ˜¯ç­–ç•¥æ¨¡å¼æ³¨å…¥ï¼Ÿ

---

## 4. Refinement Suggestions

> ä»¥ä¸‹å»ºè®®åº”æ›´æ–°åˆ° W1 é¢†åŸŸæ¨¡å‹æˆ–æŠ€æœ¯è®¾è®¡ä¸­ã€‚

### For Agent (ä»£ç†)

| Change | Type | Rationale |
|--------|------|-----------|
| æ·»åŠ  `executor_type: enum ("anthropic" | "sdk")` | New Property (Optional) | GAP-010: æ”¯æŒ Executor é€‰æ‹© |

### For Executor (æŠ€æœ¯ç»„ä»¶)

| Change | Type | Rationale |
|--------|------|-----------|
| å®šä¹‰ `IExecutor` æ¥å£ | New Interface | GAP-010: æŠ½è±¡å…¬å…±è¡Œä¸º |
| `AnthropicExecutor`, `SDKExecutor` å®ç°æ¥å£ | Refactor | å¤ç”¨å…¬å…±é€»è¾‘ï¼Œå·®å¼‚åŒ– SDK è°ƒç”¨ |

### For API

| Change | Type | Rationale |
|--------|------|-----------|
| PUT /agents/{id} æ”¯æŒ params_schema æ›´æ–° | Modify API | GAP-011 |
| GET /tickets/{id} embed sessions åˆ—è¡¨ | Modify API Response | GAP-015 |

### For Frontend

| Change | Type | Rationale |
|--------|------|-----------|
| params_schema ä¸ºç©ºæ—¶æ˜¾ç¤ºé€šç”¨ JSON è¾“å…¥ | Edge Case Handling | GAP-012 |
| Session æŒ‰é’®åœ¨æ—  Session æ—¶ç¦ç”¨ | Edge Case Handling | GAP-013 |
| åˆ·æ–°æ—¶ä¿æŒæ»šåŠ¨å’Œé€‰ä¸­çŠ¶æ€ | UX Optimization | GAP-014 |

---

## 5. Verification Checklist

| # | Scenario | Test Case | Expected Outcome |
|---|----------|-----------|------------------|
| 11 | åˆ›å»º Ticket (åŠ¨æ€è¡¨å•) | é€‰æ‹©æœ‰ params_schema çš„ Agent | å‰ç«¯æ¸²æŸ“å¯¹åº”è¡¨å•å­—æ®µ |
| 12 | åˆ›å»º Ticket (åŠ¨æ€è¡¨å•) | å¡«å†™ä¸ç¬¦åˆ schema çš„å€¼ | å‰ç«¯/åç«¯è¿”å›æ ¡éªŒé”™è¯¯ |
| 13 | åˆ›å»º Ticket (åŠ¨æ€è¡¨å•) | Agent æ—  params_schema | æ˜¾ç¤ºé€šç”¨ JSON è¾“å…¥æˆ–æç¤ºé…ç½® |
| 14 | Executor é€‰æ‹© | é…ç½®ä½¿ç”¨ SDK Executor | Ticket ä½¿ç”¨ executor2.py æ‰§è¡Œ |
| 15 | Executor é€‰æ‹© | é…ç½®ä½¿ç”¨ Anthropic Executor | Ticket ä½¿ç”¨ executor.py æ‰§è¡Œ |
| 16 | è‡ªåŠ¨åˆ·æ–° | è¿›å…¥ Ticket åˆ—è¡¨ï¼Œç­‰å¾… 5 ç§’ | åˆ—è¡¨è‡ªåŠ¨æ›´æ–°ï¼Œä¿æŒæ»šåŠ¨ä½ç½® |
| 17 | Session è·³è½¬ | æ‰“å¼€æœ‰ Session çš„ Ticket | Session æŒ‰é’®å¯ç‚¹å‡»ï¼Œè·³è½¬æˆåŠŸ |
| 18 | Session è·³è½¬ | æ‰“å¼€æ—  Session çš„ Ticket | Session æŒ‰é’®ç¦ç”¨æˆ–éšè— |

---

## 6. Design Decisions

ä»¥ä¸‹å†³ç­–å·²åœ¨å®¡è®¡è¿‡ç¨‹ä¸­ç¡®è®¤ï¼š

### 6.1 Executor é€‰æ‹©ç­–ç•¥ (GAP-010)

- **å†³ç­–**: æ–¹æ¡ˆ C - ç»Ÿä¸€æ¥å£ï¼Œè¿è¡Œæ—¶æ³¨å…¥
- **å®ç°**: 
  - å®šä¹‰ `IExecutor` æŠ½è±¡æ¥å£
  - `AnthropicExecutor` å’Œ `SDKExecutor` å®ç°è¯¥æ¥å£
  - é€šè¿‡ä¾èµ–æ³¨å…¥æˆ–å·¥å‚æ¨¡å¼åˆ‡æ¢å®ç°
- **ç†ç”±**: æœ€å¤§ç¨‹åº¦å¤ç”¨ä»£ç ï¼Œç¬¦åˆå¼€é—­åŸåˆ™

### 6.2 Ticket API Sessions è¿”å› (GAP-015)

- **å†³ç­–**: æ–¹æ¡ˆ A - embed sessions
- **å®ç°**: GET /tickets/{id} è¿”å›ä½“åŒ…å« `sessions: [{id, status, created_at}, ...]`
- **ç†ç”±**: ç®€åŒ–å‰ç«¯è¯·æ±‚ï¼Œå‡å°‘ API è°ƒç”¨æ¬¡æ•°

---

## 7. Open Questions

~~- [ ] Q3: Executor æŠ½è±¡ç­–ç•¥ç¡®è®¤~~
~~- [ ] GAP-010: Executor é€‰æ‹©ç­–ç•¥~~
~~- [ ] GAP-015: Ticket API æ˜¯å¦ embed sessions~~

âœ… æ‰€æœ‰é—®é¢˜å·²è§£å†³ï¼Œè§ Section 6: Design Decisions
